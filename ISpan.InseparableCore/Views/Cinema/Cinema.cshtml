@model ISpan.InseparableCore.ViewModels.CcinemaVM
@{
    ViewData["Title"] = "List2";
}

<h1>影城介紹</h1>
@section Styles{
    <link href="~/css/loading.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <style>
        .city, .brand {
            margin: 5px;
        }

        p {
            margin: 0px;
            font-size: 15px;
        }

        .showcinema {
            border: solid 1.8px #C4E1E1;
            padding:5px;
            margin:5px;
        }

        #cinema {
            margin: 15px;
            width: 53%;
        }

        .show {
            margin: 15px;
            width: 40%;
            border: solid 2.5px #C4E1E1;
            overflow: auto;
            padding:5px;
        }

        #map {
            width: 100%;
            height: 200px;
        }

        .color:hover {
            color: #ffc107;
            transform: scale(1.1);
        }
    </style>
}
<div>
    <div class="loadingdiv" id="loading" style="display: none">
        <img src="~/images/Infinity-1s-200px.gif" />
    </div>
    <div id="city">
        @foreach (var item in Model.city)
        {

            <button class="city btn btn-outline-primary" value="@item">@item</button>

        }
    </div>
    <div id="brand">
        @foreach (var item in Model.brand)
        {
            <button class="brand btn btn-outline-primary" value="@item">@item</button>
        }
    </div>
</div>
<div style="display:flex;">
    <div id="cinema"></div>
    <div id="show">
        <h5></h5>
        <div id="map"></div>
        <div id="traffic"></div>
    </div>
</div>

@section Scripts{
    <script>
        $(function () {
            var city = "臺北市";
            var url= '/Cinema/City';
            //todo 要先預設選擇台北button???
            getCinema(url, city);
        });

        //取得電影院
        function getCinema(url,name) {
            $.ajax({
                //beforeSend: function () {
                //    $('#loading').css("display", "");
                //}, 
                method: 'POST',
                url,
                data: {
                    name
                },
                datatype: 'text',
                success: function (data) {
                    var cinema = JSON.parse(data);
                    cinema.forEach(function (value, index) {
                        $('#cinema').append(`<div class="showcinema color" onclick="mapshow(${value.FCinemaId})"><span><a ><h4>${value.FCinemaName}</h4></a>
                                             <p>${value.FCinemaAddress}</p>
                                             <p>${value.FCinemaTel}</p>
                                             </span></div>`)
                    })
                    console.log('pass');
                },
                error: function () {
                    console.log('QQ');
                },
                //complete: function () {
                //    $('#loading').css("display", "none");
                //} 
            });
        }
        $('button').click(function(){
            //單選換class
            $('.btn-primary').addClass('btn-outline-primary');
            $('.btn-primary').removeClass('btn-primary');
            
            $(this).removeClass('btn-outline-primary');
            $(this).addClass('btn-primary');
        });

        $('#city button').click(function () {
            $('#cinema').html('');
            $('#show h5').html(``);
            $('#show h4').html(``);
            $('#map').html('');
            $('#traffic').html('');
            $('#show').removeClass('show');
            
            var city = $(this).attr('value');
            var url= '/Cinema/City';
            getCinema(url, city);
            
        });
        $('#brand button').click(function () {
            $('#cinema').html('');
            $('#show h5').html(``);
            $('#show h4').html(``);
            $('#map').html('');
            $('#traffic').html('');
            $('#show').removeClass('show');

            var brand = $(this).attr('value');
            var url= '/Cinema/Brand';
            getCinema(url, brand);
     
        });
        //map
        function sendmapRequest(id) {
            return new Promise(
                function (resolve, reject) {
                    $.ajax({
                        beforeSend: function () {
                            $('#loading').css("display", "");
                        },
                        method: 'POST',
                        url: '/Cinema/Map',
                        data: { id },
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            reject(`${textStatus} ${jqXHR.status} ${errorThrown}`);
                        },
                        complete: function () {
                            setTimeout(function () { $('#loading').css("display", "none"); }, 2000);

                        }
                    });
                });
        }


        function mapshow(id) {
            $('#show h5').html(``);
            $('#show h4').html(``);
            $('#show h5').append(`交通資訊：`);
            $('#map').html('');
            $('#traffic').html('');
            $('#show').addClass('show');
            
            sendmapRequest(id)
                .then(function (data) {
                    var cinema = JSON.parse(data);
                    $('#show').prepend(`<h4>${cinema.Name}</h4>`);
                    traffic = cinema.FTraffic;
                    traffic.forEach(function (value, index) {
                        $('#traffic').append(`<p>${value}</p>`)
                    })
                    return cinema;
                })
                .then(function (value) {
                    //map
                    var lat = value.FLat;
                    var lng = value.FLng
                    var platform = new H.service.Platform({
                        apikey: value.Key
                    });

                    var pixelRatio = window.devicePixelRatio || 1;
                    var defaultLayers = platform.createDefaultLayers({
                        tileSize: pixelRatio === 1 ? 256 : 512,
                        ppi: pixelRatio === 1 ? undefined : 320
                    });
                    var map = new H.Map(document.getElementById('map'),
                        defaultLayers.vector.normal.map, {
                        center: { lat, lng },
                        zoom: 4,
                        pixelRatio: pixelRatio
                    });

                    window.addEventListener('resize', () => map.getViewPort().resize());
                    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
                    var ui = H.ui.UI.createDefault(map, defaultLayers);
                    switchMapLanguage(map, platform);

                    moveMapToBerlin(map, lat, lng);
                    addMarkersToMap(map, lat, lng);
                });

        }
        //放大縮小
        function moveMapToBerlin(map, lat, lng) {
            map.setCenter({ lat, lng });
            map.setZoom(16);
        };

        //標記
        function addMarkersToMap(map, lat, lng) {
            var parisMarker = new H.map.Marker({ lat, lng });
            map.addObject(parisMarker);
        };

        //變中文
        function switchMapLanguage(map, platform) {
            let defaultLayers = platform.createDefaultLayers({
                lg: 'zh-tw'
            });

            map.setBaseLayer(defaultLayers.vector.normal.map);
            var ui = H.ui.UI.createDefault(map, defaultLayers, 'zh-CN');
            ui.removeControl('mapsettings');
        };
    </script>
}
